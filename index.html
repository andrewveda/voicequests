<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé§ Self-Introduction Practice with Grammar Check</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0; padding: 20px;
    }
    h1 { text-align: center; }
    .dialogue {
      background: white;
      margin: 10px auto;
      padding: 15px;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .locked { opacity: 0.4; pointer-events: none; }
    .active { border-left: 5px solid #0077cc; }
    button {
      background: #0077cc; color: white;
      border: none; padding: 8px 16px;
      border-radius: 5px; cursor: pointer;
    }
    .feedback { margin-top: 10px; }
    .success { color: green; }
    .fail { color: red; }
    .transcript {
      margin-top: 5px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>üé§ Self-Introduction Practice</h1>
  <p style="text-align:center;">Speak each part aloud. Grammar mistakes will be highlighted. Only correct sentences unlock the next step.</p>

  <div id="exercise"></div>

  <script>
    const lines = [
      "Good morning everyone.",
      "My name is [Your Name].",
      "I come from [Your City].",
      "I am pursuing my degree in [Your Course] at [Your College].",
      "There are [number] members in my family.",
      "My father is a [profession].",
      "My mother is a [profession].",
      "My strengths are that I am hardworking and honest.",
      "My hobbies are reading books and playing chess.",
      "In the future, I would like to become a software engineer.",
      "That was a short introduction about myself. Thank you."
    ];

    const container = document.getElementById("exercise");
    let currentIndex = 0;

    // render dialogue steps
    lines.forEach((line, i) => {
      const div = document.createElement("div");
      div.className = "dialogue locked";
      if (i === 0) { div.classList.add("active"); div.classList.remove("locked"); }
      div.innerHTML = `
        <strong>Step ${i+1}:</strong> ${line}<br>
        <button onclick="startRecognition(${i})">üéô Speak</button>
        <div class="transcript" id="transcript-${i}"></div>
        <div class="feedback" id="feedback-${i}"></div>
      `;
      container.appendChild(div);
    });

    // SpeechRecognition
    let recognition;
    function initRecognition() {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-GB";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = async function(event) {
        const spoken = event.results[0][0].transcript;
        const transcriptDiv = document.getElementById(`transcript-${currentIndex}`);
        transcriptDiv.textContent = `You said: "${spoken}"`;

        const feedbackDiv = document.getElementById(`feedback-${currentIndex}`);

        const corrections = await checkGrammar(spoken);
        if (corrections.length === 0) {
          feedbackDiv.textContent = "‚úÖ Correct!";
          feedbackDiv.className = "feedback success";
          unlockNext();
        } else {
          let msg = "";
          corrections.forEach(c => {
            msg += `‚ùå ${c.message} Suggestion: ${c.replacements.join(", ")}<br>`;
          });
          feedbackDiv.innerHTML = msg;
          feedbackDiv.className = "feedback fail";
        }
      };

      recognition.onerror = function(event) {
        alert("Recognition error: " + event.error);
      };
    }

    function startRecognition(index) {
      if (index !== currentIndex) return;
      recognition.start();
    }

    function unlockNext() {
      const all = document.querySelectorAll(".dialogue");
      all[currentIndex].classList.remove("active");
      currentIndex++;
      if (all[currentIndex]) {
        all[currentIndex].classList.remove("locked");
        all[currentIndex].classList.add("active");
      }
    }

    // LanguageTool grammar check via public API
    async function checkGrammar(text) {
      try {
        const response = await fetch("https://api.languagetool.org/v2/check", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `language=en-GB&text=${encodeURIComponent(text)}`
        });
        const data = await response.json();
        // map matches to simplified format
        return data.matches.map(m => ({
          message: m.message,
          replacements: m.replacements.map(r => r.value)
        }));
      } catch (err) {
        console.error("Grammar API error:", err);
        return [{ message: "Grammar check failed. Try again.", replacements: [] }];
      }
    }

    initRecognition();
  </script>
</body>
</html>
