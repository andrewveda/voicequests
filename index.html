<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPA Pronunciation Trainer</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 20px;
  }
  h1 {
    text-align: center;
  }
  .ipa-block {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  button {
    padding: 8px 12px;
    margin: 5px 5px 0 0;
    border: none;
    border-radius: 5px;
    background: #333;
    color: white;
    cursor: pointer;
  }
  p {
    margin: 5px 0;
  }
  .feedback {
    font-weight: bold;
    margin-top: 5px;
  }
  .success { color: green; }
  .fail { color: red; }
</style>
</head>
<body>
  <h1>IPA Pronunciation Trainer (British English)</h1>

  <div id="ipa-container"></div>

  <script>
    const ipaSounds = [
      {symbol:"/p/", words:["pen","map","apple"]},
      {symbol:"/b/", words:["ball","table","cab"]},
      {symbol:"/t/", words:["top","cat","tea"]},
      {symbol:"/d/", words:["dog","add","ride"]},
      {symbol:"/k/", words:["cat","back","cake"]},
      {symbol:"/g/", words:["go","bag","egg"]},
      {symbol:"/f/", words:["fish","leaf","coffee"]},
      {symbol:"/v/", words:["van","leave","save"]},
      {symbol:"/θ/", words:["think","both","bath"]},
      {symbol:"/ð/", words:["this","mother","breathe"]}
    ];

    const container = document.getElementById("ipa-container");

    ipaSounds.forEach((item, index)=>{
      const block = document.createElement("div");
      block.className = "ipa-block";
      let wordsHTML = '';
      item.words.forEach((word, wIndex)=>{
        wordsHTML += `
          <div>
            <strong>${word}</strong>
            <button onclick="speakWord('${word}')">🔊 Play</button>
            <button onclick="startRecognition('${word}', ${index}, ${wIndex})">🎤 Repeat</button>
            <div class="feedback" id="feedback-${index}-${wIndex}"></div>
          </div>
        `;
      });
      block.innerHTML = `
        <p><strong>IPA:</strong> ${item.symbol}</p>
        ${wordsHTML}
      `;
      container.appendChild(block);
    });

    // Speech synthesis
    function speakWord(word){
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = "en-GB";
      speechSynthesis.speak(utterance);
    }

    // Speech recognition
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-GB";
    recognition.interimResults = false;

    function startRecognition(expectedWord, index, wIndex){
      recognition.start();
      recognition.onresult = (event)=>{
        const spoken = event.results[0][0].transcript.trim().toLowerCase();
        checkAnswer(spoken, expectedWord.toLowerCase(), index, wIndex);
      };
      recognition.onerror = (event)=>{
        const feedback = document.getElementById(`feedback-${index}-${wIndex}`);
        feedback.textContent = `⚠️ Error: ${event.error}`;
        feedback.className = "feedback fail";
      };
    }

    function checkAnswer(spoken, expected, index, wIndex){
      const feedback = document.getElementById(`feedback-${index}-${wIndex}`);
      const similarity = compareText(spoken, expected);
      if(similarity >= 0.9){
        feedback.textContent = `✅ Correct! (${Math.round(similarity*100)}%) You said: "${spoken}"`;
        feedback.className = "feedback success";
      } else {
        feedback.textContent = `❌ Incorrect (${Math.round(similarity*100)}%). You said: "${spoken}"`;
        feedback.className = "feedback fail";
      }
    }

    // Levenshtein similarity
    function compareText(a,b){
      const longer = a.length > b.length ? a : b;
      const shorter = a.length > b.length ? b : a;
      const longerLength = longer.length;
      if(longerLength === 0) return 1.0;
      return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2){
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      const costs = [];
      for(let i=0;i<=s1.length;i++){
        let lastValue=i;
        for(let j=0;j<=s2.length;j++){
          if(i===0) costs[j]=j;
          else{
            if(j>0){
              let newValue=costs[j-1];
              if(s1.charAt(i-1)!==s2.charAt(j-1)){
                newValue = Math.min(Math.min(newValue,lastValue),costs[j])+1;
              }
              costs[j-1]=lastValue;
              lastValue=newValue;
              lastValue=newValue;
            }
          }
        }
        if(i>0) costs[s2.length]=lastValue;
      }
      return costs[s2.length];
    }
  </script>
</body>
</html>
