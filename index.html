<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice & Text Assessment</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding: 30px; max-width: 800px; margin: auto; }
  h1 { text-align: center; }
  .step { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .active { display: block; }
  textarea { width: 100%; height: 120px; margin-top: 10px; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
  button { padding: 10px 25px; border: none; border-radius: 6px; margin-top: 10px; cursor: pointer; background: #0066cc; color: white; font-size: 15px; }
  button:hover { background: #004999; }
  .score { margin-top: 10px; font-weight: bold; color: #006600; }
  audio { display: block; margin-top: 10px; }
</style>
</head>
<body>

<h1>Student Voice & Text Assessment</h1>
<label>Student Name: <input type="text" id="studentName" placeholder="Enter your name"></label>

<div id="steps">

  <!-- Step 1: Type Answer for Q1 -->
  <div class="step active" id="step1" data-type="text" data-qid="1">
    <h2>Question 1</h2>
    <p>Describe your favourite book.</p>
    <textarea placeholder="Type your answer here..."></textarea>
    <button onclick="nextStep()">Next ‚û°Ô∏è</button>
  </div>

  <!-- Step 2: Record Answer for Q1 -->
  <div class="step" id="step2" data-type="record" data-qid="1">
    <h2>Question 1 (Voice Recording)</h2>
    <p>Please record your answer now.</p>
    <button onclick="startRecording(this)">üéô Start Recording</button>
    <button onclick="stopRecording(this)">‚èπ Stop & Analyse</button>
    <audio controls></audio>
    <div class="score"></div>
    <button onclick="nextStep()">Next ‚û°Ô∏è</button>
  </div>

  <!-- Step 3: Type Answer for Q2 -->
  <div class="step" id="step3" data-type="text" data-qid="2">
    <h2>Question 2</h2>
    <p>Describe your favourite hobby.</p>
    <textarea placeholder="Type your answer here..."></textarea>
    <button onclick="nextStep()">Next ‚û°Ô∏è</button>
  </div>

  <!-- Step 4: Record Answer for Q2 -->
  <div class="step" id="step4" data-type="record" data-qid="2">
    <h2>Question 2 (Voice Recording)</h2>
    <p>Please record your answer now.</p>
    <button onclick="startRecording(this)">üéô Start Recording</button>
    <button onclick="stopRecording(this)">‚èπ Stop & Analyse</button>
    <audio controls></audio>
    <div class="score"></div>
    <button onclick="submitAll()">Submit All Answers ‚úÖ</button>
  </div>

</div>

<script>
let currentStep = 1;
let mediaRecorder;
let audioChunks = [];
let answers = {};

function nextStep() {
  const current = document.getElementById(`step${currentStep}`);
  if (current.dataset.type === "text") {
    const text = current.querySelector('textarea').value.trim();
    if (!text) return alert('Please type your answer before continuing.');
    answers[`q${current.dataset.qid}`] = { typedText: text };
  }
  current.classList.remove('active');
  currentStep++;
  const next = document.getElementById(`step${currentStep}`);
  if (next) next.classList.add('active');
}

async function startRecording(btn) {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  const step = btn.closest('.step');
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  alert('Recording started...');
}

async function stopRecording(btn) {
  if (!mediaRecorder) return;
  const step = btn.closest('.step');
  mediaRecorder.stop();
  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const audioUrl = URL.createObjectURL(audioBlob);
    const audioElement = step.querySelector('audio');
    audioElement.src = audioUrl;

    const qid = step.dataset.qid;
    const typedText = answers[`q${qid}`].typedText;

    // Simulate Speech-to-Text transcription (replace with real API)
    const spokenText = await mockSpeechToText(audioBlob);

    // Calculate similarity
    const similarity = compareText(spokenText, typedText);
    const score = Math.round(similarity * 100);

    step.querySelector('.score').innerText = `Voice Accuracy Score: ${score}%`;
    answers[`q${qid}`].voiceScore = score;
  };
}

async function mockSpeechToText(audioBlob) {
  // For demo, simulate transcription by returning a slightly modified version
  return "simulated speech version of your answer";
}

// Compare text similarity
function compareText(a, b) {
  a = a.toLowerCase().trim();
  b = b.toLowerCase().trim();
  const longer = a.length > b.length ? a : b;
  const shorter = a.length > b.length ? b : a;
  if (longer.length === 0) return 1.0;
  return (longer.length - editDistance(longer, shorter)) / longer.length;
}

// Levenshtein distance
function editDistance(s1, s2) {
  const dp = Array(s1.length + 1).fill(null).map(() => Array(s2.length + 1).fill(0));
  for (let i = 0; i <= s1.length; i++) dp[i][0] = i;
  for (let j = 0; j <= s2.length; j++) dp[0][j] = j;
  for (let i = 1; i <= s1.length; i++) {
    for (let j = 1; j <= s2.length; j++) {
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + (s1[i-1] === s2[j-1] ? 0 : 1)
      );
    }
  }
  return dp[s1.length][s2.length];
}

async function submitAll() {
  const studentName = document.getElementById('studentName').value;
  if (!studentName) return alert('Please enter your name before submitting.');

  const payload = {
    studentName,
    questions: Object.values(answers)
  };

  const res = await fetch('https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec', {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  });

  const result = await res.json();
  if (result.status === 'success') {
    alert('‚úÖ Submission successful!');
    location.reload();
  } else {
    alert('‚ùå Submission failed.');
  }
}
</script>

</body>
</html>
